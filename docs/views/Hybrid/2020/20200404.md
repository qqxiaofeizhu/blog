---
title: H5与App通信之Hybrid
date: 2020-04-04
tags:
 - Hybrid App
categories:
 - Hybrid
---

## HyBrid 实现

```js
/**
 * 传统 webview 通信方案
 * callHandler H5调用APP注册的事件
 * registerhandler H5注册供APP调用的事件
 */

let u = navigator.userAgent,
    isAndroid = u.indexOf('Android') > -1 || u.indexOf('Adr') > -1;

function setupWebViewJavascriptBridge(callback) {
    if (isAndroid) {
        document.addEventListener(
            'WebViewJavascriptBridgeReady',
            function () {
                callback(WebViewJavascriptBridge)
            },
            false
        );
    } else {
        window.WVJBCallbacks = [callback]
        let WVJBIframe = document.createElement('iframe')
        WVJBIframe.style.display = 'none'
        WVJBIframe.src = 'wvjbscheme://__BRIDGE_LOADED__'
        document.documentElement.appendChild(WVJBIframe)
        setTimeout(() => {
            document.documentElement.removeChild(WVJBIframe)
        }, 0)
    }
    if (window.WebViewJavascriptBridge) {
        return callback(window.WebViewJavascriptBridge)
    }
    if (window.WVJBCallbacks) {
        return window.WVJBCallbacks.push(callback)
    }
}

setupWebViewJavascriptBridge(bridge => {
    if (isAndroid) {
        bridge.init();
    }
})

export default {
    callHandler(name, data, callback) {
        setupWebViewJavascriptBridge(bridge => {
            bridge.callHandler(name, data, callback)
        })
    },
    registerHandler(name, callback) {
        setupWebViewJavascriptBridge(function (bridge) {
            bridge.registerHandler(name, (data, responseCallback) => {
                callback(data, responseCallback)
            })
        })
    }
}
```

## HyBrid Promise化

```js
function JsBridge() {
    /**
     * @description JS调用原生
    */
    JsBridge.prototype.callHandler = function (key, customData) {
        return new Promise((resolve) => {
            Bridge.callHandler(key, customData, (appData) => {
                resolve(appData);
            })
        })
    }

    /**
     * @description 原生调用JS，因为是callback, 暂时没有想到如何promise result
    */
    JsBridge.prototype.registerHandler = function (key, callHandler) {
        Bridge.registerHandler(key, callHandler)
    }
}
```
## hyBrid 设计

### jsBridge

::: tip
1. 码值就是`H5`和`APP`交互过程中传递参数下`code`值的别名
2. 每个`APP`的码值不完全一致，需要参考每个`APP`下对应码值关系列表
3. 每个`APP`中码值表的值是唯一的
:::

### jsCallApp

`jsCallApp`为`APP`中注册函数名称，`APP`根据`H5`发送`data`数据中的`code`值，返回给`H5 code`值对应的数据。

`H5`发送的`data`数据格式如下：

```js
data: {
    code: 表中code值, 所属定义事件的码值，具体参考码值表
    data: any 当前码值传递给APP的额外数据，可以为任何类型，具体的类型可以参考码值定义表
    desc: String 对应码值的描述信息
}
```
`APP`在接收到`H5`数据后，返回给`H5`数据格式如码值表`returns`所示

### appCallJs

`appCallJs`为`H5`中注册函数名称, `JS`根据`APP`发送`data`数据中的`code`值，返回给`APP`对应的数据。

`APP`发送的`data`数据格式如下：

```js
data: {
    code: 表中code值, 所属定义事件的码值，具体参考码值表
    data: any 当前码值传递给H5的额外数据，可以为任何类型，具体的类型可以参考码值定义表,
    desc: String 对应码值的描述信息
}
```

`H5`在接收到`APP`数据后，返回给`APP`数据格式如码值表`returns`所示

## 码值定义规则

1. 系统的码值：`sy`
2. 公共页面码值：`cc`
3. `app`自定义的码值：`ac`
4. `H5` 自定义的码值：`jc`
5. 日志搜集的码值: `log`

对于系统码值表来言，每个`app` 对应s的系统码值是一致的，具体含义请参考系统码值表

对于`cc`请参考公共页面码值描述

对于`ac`和`jc`请参考对应的`app`码值描述

对于值为`array`, `object`类型的数据，`ios`正常传递，安卓传`stringify`后数据

### 系统码值表举例

| code<br/>码值 | data <br/> H5传递的数据  | desc<br/> 当前事件功能描述 | @returns <br/> app返回数据 |
| ------------- |:-------------:|:--------:|:----:|:----:|--------:|
|sy1|"标题名"|设置webview的标题|`Boolean`类型：true/false|
|sy2|null|关闭当前webview|`Boolean`类型：true/false|

### 日志搜集码值表举例

| code<br/>码值 | data <br/> H5传递的数据  | desc<br/> 当前事件功能描述 | @returns <br/> app返回数据 |
| ------------- |:-------------:|:--------:|:----:|:----:|--------:|
|log|参考app定义格式|发送对应页面的log日志信息|`Boolean`类型：true/false|

---
title: H5与App通信之Hybrid
date: 2020-04-04
tags:
 - Hybrid App
categories:
 - Hybrid
---

## HyBrid 实现

```js
/**
 * 传统 webview 通信方案
 * callHandler H5调用APP注册的事件
 * registerhandler H5注册供APP调用的事件
 */

let u = navigator.userAgent,
    isAndroid = u.indexOf('Android') > -1 || u.indexOf('Adr') > -1;

function setupWebViewJavascriptBridge(callback) {
    if (isAndroid) {
        document.addEventListener(
            'WebViewJavascriptBridgeReady',
            function () {
                callback(WebViewJavascriptBridge)
            },
            false
        );
    } else {
        window.WVJBCallbacks = [callback]
        let WVJBIframe = document.createElement('iframe')
        WVJBIframe.style.display = 'none'
        WVJBIframe.src = 'wvjbscheme://__BRIDGE_LOADED__'
        document.documentElement.appendChild(WVJBIframe)
        setTimeout(() => {
            document.documentElement.removeChild(WVJBIframe)
        }, 0)
    }
    if (window.WebViewJavascriptBridge) {
        return callback(window.WebViewJavascriptBridge)
    }
    if (window.WVJBCallbacks) {
        return window.WVJBCallbacks.push(callback)
    }
}

setupWebViewJavascriptBridge(bridge => {
    if (isAndroid) {
        bridge.init();
    }
})

export default {
    callHandler(name, data, callback) {
        setupWebViewJavascriptBridge(bridge => {
            bridge.callHandler(name, data, callback)
        })
    },
    registerHandler(name, callback) {
        setupWebViewJavascriptBridge(function (bridge) {
            bridge.registerHandler(name, (data, responseCallback) => {
                callback(data, responseCallback)
            })
        })
    }
}
```

## HyBrid Promise化

```js
function JsBridge() {
    /**
     * @description JS调用原生
    */
    JsBridge.prototype.callHandler = function (key, customData) {
        return new Promise((resolve) => {
            Bridge.callHandler(key, customData, (appData) => {
                resolve(appData);
            })
        })
    }

    /**
     * @description 原生调用JS
    */
    JsBridge.prototype.registerHandler = function (key, callHandler) {
        return new Promise((resolve) => {
            Bridge.registerHandler(key, callHandler)
        })
    }
}
```